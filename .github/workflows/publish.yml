# PyPI 發佈工作流程
#
# 觸發方式（二擇一）：
#   A. 推送 v* tag → 自動發佈到 PyPI + 建立 GitHub Release（正式版）
#   B. 手動觸發 → 發佈到 TestPyPI（測試用）
#
# 使用前需設定 GitHub Secrets：
#   - PYPI_API_TOKEN        : PyPI 的 API Token
#   - TEST_PYPI_API_TOKEN   : TestPyPI 的 API Token
#
# 發版流程：
#   1. 修改 pyproject.toml 中的 version（例如 "1.1.0"）
#   2. git commit -m "release: v1.1.0"
#   3. git tag v1.1.0 && git push origin main --tags
#   4. GitHub Actions 自動觸發：發佈到 PyPI + 建立 GitHub Release
#
# 測試發佈：
#   1. 修改 pyproject.toml version 為 rc 版號（例如 "1.1.0rc1"）
#   2. Commit & Push 到 main
#   3. 到 Actions 頁面手動觸發（僅 TestPyPI）
#
# 版號防護（雙向檢查）：
#   - Tag 觸發（PyPI）：版號不可含 rc/dev/alpha/beta 後綴
#   - 手動觸發（TestPyPI）：版號必須含 rc/dev/alpha/beta 後綴

name: Publish to PyPI

on:
  push:
    tags:
      - "v*"

  workflow_dispatch:

jobs:
  publish:
    name: Build & Publish
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.12

      # 取得版本號供後續步驟使用
      - name: Get version
        id: version
        run: |
          VERSION=$(grep '^version' pyproject.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      # 驗證 tag 版號與 pyproject.toml 一致，且不含預發佈後綴（僅 tag 觸發時檢查）
      - name: Verify tag matches version
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          TAG="${GITHUB_REF#refs/tags/v}"
          TOML="${{ steps.version.outputs.version }}"
          if [ "${TAG}" != "${TOML}" ]; then
            echo "::error::Tag v${TAG} does not match pyproject.toml version ${TOML}"
            echo "Please ensure the tag matches: git tag v${TOML}"
            exit 1
          fi
          if echo "${TOML}" | grep -qE '(rc|dev|alpha|beta)'; then
            echo "::error::Pre-release version ${TOML} should not be published to PyPI"
            echo "Please use workflow_dispatch to publish to TestPyPI instead"
            exit 1
          fi
          echo "Version check passed: v${TAG} == ${TOML}"

      # 驗證手動觸發時版號必須含預發佈後綴（避免正式版號浪費在 TestPyPI）
      - name: Verify pre-release version for TestPyPI
        if: github.event_name == 'workflow_dispatch'
        run: |
          TOML="${{ steps.version.outputs.version }}"
          if ! echo "${TOML}" | grep -qE '(rc|dev|alpha|beta)'; then
            echo "::error::Version ${TOML} does not contain a pre-release suffix (rc/dev/alpha/beta)"
            echo "Please use a pre-release version (e.g. ${TOML}rc1) for TestPyPI"
            exit 1
          fi
          echo "Pre-release check passed: ${TOML}"

      - name: Build package
        run: uv build

      # Tag 觸發 → 發佈到 PyPI
      - name: Publish to PyPI (tag)
        if: startsWith(github.ref, 'refs/tags/v') && github.event_name == 'push'
        run: uv publish
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}

      # 手動觸發 → TestPyPI
      - name: Publish to TestPyPI (manual)
        if: github.event_name == 'workflow_dispatch'
        run: uv publish --publish-url https://test.pypi.org/legacy/
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.TEST_PYPI_API_TOKEN }}

      # 建立 GitHub Release（僅 tag 觸發時）
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v') && github.event_name == 'push'
        run: gh release create "${{ github.ref_name }}" --generate-notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          V="${{ steps.version.outputs.version }}"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "### ✅ Published v${V} to TestPyPI" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Install: \`pip install -i https://test.pypi.org/simple/ claude-code-dashboard==${V}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ✅ Published v${V} to PyPI" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Install: \`pip install claude-code-dashboard==${V}\`" >> $GITHUB_STEP_SUMMARY
          fi
